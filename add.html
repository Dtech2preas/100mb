<!DOCTYPE html>
<html>
<head>
  <title>D-TECH Gist Mapper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    input, button { display: block; margin: 10px 0; width: 100%; padding: 8px; }
    #log { margin-top: 20px; white-space: pre-wrap; background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>

  <h2>Subdomain Gist Entry Manager</h2>

  <input type="text" id="name" placeholder="Your Name (e.g. lefa)" />
  <input type="url" id="url" placeholder="Your Gist URL" />

  <button onclick="createOrUpdate('create')">Create Entry (1h)</button>
  <button onclick="createOrUpdate('extend')">Add 1 Hour</button>
  <button onclick="checkTime()">Check Remaining Time</button>

  <div id="log">...</div>

  <script>
    const mappingGistRaw = "https://gist.githubusercontent.com/Preasx24/451a35def0daf123212fcb9729d3dfdd/raw/gistfile1.txt";
    const tokenGistRaw = "https://gist.githubusercontent.com/Preasx24/137f29d4b3b32c251bf6b7ab2b3fae28/raw/gistfile1.txt";
    const log = msg => document.getElementById("log").textContent = msg;

    async function getToken() {
      const res = await fetch(tokenGistRaw);
      return (await res.text()).split("\n")[0].trim();
    }

    async function getGistMeta(token) {
      const res = await fetch("https://api.github.com/gists", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const gists = await res.json();
      return gists.find(g => g.files["gistfile1.txt"] && g.description.includes("mapping")) || gists[0];
    }

    async function loadMapping() {
      const res = await fetch(mappingGistRaw);
      return JSON.parse(await res.text());
    }

    function getUnix() {
      return Math.floor(Date.now() / 1000);
    }

    async function createOrUpdate(mode) {
      const name = document.getElementById("name").value.trim();
      const url = document.getElementById("url").value.trim();
      if (!name || (mode === "create" && !url)) return log("Please fill in name and URL");

      const token = await getToken();
      const meta = await getGistMeta(token);
      const mapping = await loadMapping();

      if (!mapping._expires) mapping._expires = {};

      if (mode === 'create') {
        mapping[name] = url;
        mapping._expires[name] = getUnix() + 3600;
        log(`Created entry for ${name} (expires in 1h)`);
      } else if (mode === 'extend') {
        if (!mapping[name]) return log(`No entry found for "${name}" to extend`);
        if (!mapping._expires[name]) mapping._expires[name] = getUnix();
        mapping._expires[name] += 3600;
        log(`Extended ${name} by +1 hour`);
      }

      await fetch(`https://api.github.com/gists/${meta.id}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          files: {
            "gistfile1.txt": {
              content: JSON.stringify(mapping, null, 2)
            }
          }
        })
      });
    }

    async function checkTime() {
      const name = document.getElementById("name").value.trim();
      if (!name) return log("Enter a name to check");

      const mapping = await loadMapping();
      const expires = mapping._expires?.[name];
      if (!expires) return log(`No expiry set for "${name}"`);

      const remaining = expires - getUnix();
      if (remaining <= 0) return log(`${name} has expired`);

      const mins = Math.floor(remaining / 60);
      const hrs = Math.floor(mins / 60);
      log(`${name} has ${hrs}h ${mins % 60}min left`);
    }
  </script>

</body>
</html>