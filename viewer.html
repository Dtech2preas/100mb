<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beauty Showcase — Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <style>
    :root {
      --bg:#000;
      --overlay-gradient: linear-gradient(180deg, rgba(0,0,0,.75) 0%, rgba(0,0,0,0) 60%);
      --footer-gradient: linear-gradient(0deg, rgba(0,0,0,.75) 0%, rgba(0,0,0,0) 60%);
      --radius:10px;
      --transition:.25s ease;
    }
    *{box-sizing:border-box;}
    body { margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background:#000; color:#fff; overflow:hidden; }
    .identity-button {
      position:fixed;
      top:12px;
      right:12px;
      background:rgba(255,255,255,.1);
      border:none;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:2px;
      align-items:flex-start;
      width:44px;
      height:36px;
      justify-content:center;
      backdrop-filter:blur(6px);
    }
    .identity-button span {
      display:block;
      width:22px;
      height:2px;
      background:#fff;
      border-radius:2px;
    }
    .viewer-container {
      height:100vh;
      overflow-y:scroll;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .profile-slide {
      position:relative;
      height:100vh;
      scroll-snap-align: start;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
    }
    .profile-slide img {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      user-select:none;
    }
    .overlay-top {
      position:absolute;
      top:0;
      left:0;
      right:0;
      padding:16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      background: var(--overlay-gradient);
      z-index:2;
    }
    .profile-info {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .profile-info .username {
      font-size:1.4rem;
      font-weight:700;
    }
    .profile-info .sub {
      font-size:0.9rem;
      opacity:0.9;
    }
    .like-area {
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:8px;
    }
    .like-btn {
      background:rgba(255,64,129,0.9);
      border:none;
      padding:10px 16px;
      border-radius:999px;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:6px;
      color:#fff;
    }
    .likes-count {
      font-weight:600;
    }
    .viewer-footer {
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      padding:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: var(--footer-gradient);
      z-index:2;
      gap:12px;
      flex-wrap:wrap;
    }
    .user-status {
      font-size:0.9rem;
    }
    .limit-warning {
      color:#ffb3b3;
    }
    .loader {
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:rgba(0,0,0,.6);
      padding:12px 16px;
      border-radius:8px;
      font-size:14px;
    }
    .refresh-hint {
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:rgba(255,255,255,.1);
      padding:10px 14px;
      border-radius:8px;
      font-size:12px;
    }
  </style>
</head>
<body>
  <button class="identity-button" aria-label="Settings" onclick="location.href='settings.html'">
    <span></span><span></span><span></span>
  </button>

  <div class="viewer-container" id="viewerContainer">
    <!-- slides inserted here -->
  </div>

  <div class="viewer-footer" id="footerBar">
    <div class="user-status" id="identityDisplay">Loading identity...</div>
    <div class="user-status" id="likeStatus">Likes left: --</div>
  </div>

  <div class="loader" id="globalStatus" style="display:none;">Loading...</div>

  <script>
    // CONFIG
    const GIST_TOKEN_URL="https://gist.githubusercontent.com/Dtech2preas/6750d0418aaa9dfe7f297c26d1dfae48/raw/2e511e4d11267d5aade0229849446b7297ae01c9/gistfile1.txt";
    const REPO_OWNER="Dtech2preas", REPO_NAME="Oratilr", DATA_FILE_PATH="data1.json";
    const TOKEN_TTL=30000;
    const MAX_LIKES_LOGGED=10, MAX_LIKES_ANON=5;

    // STATE
    let identity=null;
    let cachedToken=null, tokenFetchedAt=0;
    let profiles=[];
    let currentIndex=0;
    let isUpdating=false;

    // DOM
    const viewerContainer=document.getElementById("viewerContainer");
    const identityDisplay=document.getElementById("identityDisplay");
    const likeStatus=document.getElementById("likeStatus");
    const globalStatus=document.getElementById("globalStatus");

    function showStatus(msg) {
      globalStatus.textContent=msg;
      globalStatus.style.display="block";
    }
    function hideStatus() {
      globalStatus.style.display="none";
    }
    function escapeHTML(s){ if(!s) return ""; return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }

    function loadIdentity() {
      try {
        const stored=JSON.parse(localStorage.getItem("beauty_identity")||"null");
        if (!stored || !stored.username) throw new Error("no identity");
        const today=new Date().toISOString().slice(0,10);
        if (stored.lastLikeDate !== today) {
          stored.likesToday = 0;
          stored.lastLikeDate = today;
        }
        identity = stored;
        localStorage.setItem("beauty_identity", JSON.stringify(identity));
        refreshIdentityUI();
        return;
      } catch {
        location.href="auth.html";
      }
    }

    function refreshIdentityUI() {
      if (!identity) return;
      const used = identity.likesToday||0;
      const cap = identity.anonymous ? MAX_LIKES_ANON : MAX_LIKES_LOGGED;
      identityDisplay.innerHTML = identity.anonymous
        ? `Anonymous: <strong>${escapeHTML(identity.username)}</strong>`
        : `Logged in: <strong>${escapeHTML(identity.username)}</strong>`;
      likeStatus.innerHTML = `Likes today: <strong>${used}/${cap}</strong>`;
      if (used >= cap) {
        likeStatus.classList.add("limit-warning");
      } else {
        likeStatus.classList.remove("limit-warning");
      }
    }

    function canLike() {
      if (!identity) return false;
      const cap = identity.anonymous ? MAX_LIKES_ANON : MAX_LIKES_LOGGED;
      return (identity.likesToday||0) < cap;
    }

    function recordLike() {
      const today = new Date().toISOString().slice(0,10);
      if (!identity) return;
      if (identity.lastLikeDate !== today) {
        identity.likesToday = 0;
        identity.lastLikeDate = today;
      }
      identity.likesToday = (identity.likesToday||0) + 1;
      localStorage.setItem("beauty_identity", JSON.stringify(identity));
      refreshIdentityUI();
    }

    async function timeoutFetch(url, opts={}, ms=8000) {
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), ms);
      try {
        return await fetch(url, {...opts, signal: controller.signal});
      } finally {
        clearTimeout(id);
      }
    }

    async function fetchToken() {
      if (cachedToken && (Date.now() - tokenFetchedAt) < TOKEN_TTL) return cachedToken;
      const res = await timeoutFetch(GIST_TOKEN_URL);
      if (!res || !res.ok) throw new Error("token fetch failed");
      const t = (await res.text()).trim();
      if (!t) throw new Error("empty token");
      cachedToken = t;
      tokenFetchedAt = Date.now();
      return t;
    }

    async function getRepoFile(token) {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
      const res = await timeoutFetch(url, {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github.v3+json"
        }
      });
      if (!res.ok) throw new Error("failed to fetch contents");
      return await res.json();
    }

    async function updateRepoFile(token, sha, arr) {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
      const body = {
        message: "Update profile",
        content: btoa(unescape(encodeURIComponent(JSON.stringify(arr, null, 2)))),
        sha
      };
      const res = await timeoutFetch(url, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github.v3+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      }, 10000);
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("update failed: " + txt);
      }
      return await res.json();
    }

    async function loadProfiles() {
      showStatus("Loading gallery...");
      try {
        const token = await fetchToken();
        const fileInfo = await getRepoFile(token);
        let arr = [];
        try { arr = JSON.parse(atob(fileInfo.content)); } catch {}
        if (!Array.isArray(arr)) arr = [];
        profiles = arr;
        hideStatus();
        renderAllSlides();
      } catch (e) {
        showStatus("Failed to load profiles: " + e.message);
      }
    }

    function renderAllSlides() {
      viewerContainer.innerHTML = "";
      if (!profiles.length) {
        viewerContainer.innerHTML = '<div class="profile-slide"><div style="text-align:center;color:#fff;">No profiles yet.</div></div>';
        return;
      }
      profiles.sort((a,b)=> (b.likes||0)-(a.likes||0));
      profiles.forEach((p, idx) => {
        const slide = document.createElement("div");
        slide.className = "profile-slide";
        slide.dataset.index = idx;
        slide.innerHTML = `
          <img src="${escapeHTML(p.image)}" loading="lazy" alt="${escapeHTML(p.username||'profile')}" />
          <div class="overlay-top">
            <div class="profile-info">
              <div class="username">${escapeHTML(p.username || "")}</div>
              <div class="sub">
                ${p.fullName? escapeHTML(p.fullName) + " • " : ""}Age: ${escapeHTML(String(p.age||""))} • Uploaded: ${new Date(p.timestamp||0).toLocaleString()}
              </div>
              <div class="like-area">
                <button class="like-btn" data-username="${escapeHTML(p.username)}">❤️ <span class="likes-count">${p.likes||0}</span></button>
              </div>
            </div>
          </div>
        `;
        viewerContainer.appendChild(slide);
      });
      // attach like handlers
      document.querySelectorAll(".like-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          if (isUpdating) return;
          const target = btn.dataset.username;
          if (!identity) {
            alert("No identity; please login."); // fallback
            return;
          }
          if (!canLike()) {
            alert(identity.anonymous
              ? `Anonymous limit reached (${MAX_LIKES_ANON}/day).`
              : `Limit reached (${MAX_LIKES_LOGGED}/day).`);
            return;
          }
          isUpdating = true;
          btn.disabled = true;
          try {
            showStatus("Updating like...");
            await incrementLike(target);
            recordLike();
            refreshIdentityUI();
            // reflect UI
            const span = btn.querySelector(".likes-count");
            if (span) {
              // find updated value from profiles
              const updated = profiles.find(p => String(p.username).toLowerCase() === String(target).toLowerCase());
              span.textContent = updated?.likes || "0";
            }
            hideStatus();
          } catch (err) {
            showStatus("Like failed: " + err.message);
          } finally {
            btn.disabled = false;
            isUpdating = false;
          }
        });
      });
    }

    async function incrementLike(username, maxRetries=3) {
      for (let attempt=1; attempt<=maxRetries; attempt++) {
        const token = await fetchToken();
        const fileInfo = await getRepoFile(token);
        let arr = [];
        try { arr = JSON.parse(atob(fileInfo.content)); } catch {}
        const idx = arr.findIndex(x=> String(x.username).toLowerCase() === String(username).toLowerCase());
        if (idx === -1) throw new Error("Profile not found");
        arr[idx].likes = (arr[idx].likes||0) + 1;
        try {
          await updateRepoFile(token, fileInfo.sha, arr);
          profiles = arr; // update local copy
          return arr[idx].likes;
        } catch (e) {
          if ((e.message.includes("409") || e.code === 409) && attempt < maxRetries) {
            await new Promise(r=>setTimeout(r, 100 * attempt));
            continue;
          }
          throw e;
        }
      }
      throw new Error("Failed to increment like after retries");
    }

    // snap tracking to highlight current slide if needed
    viewerContainer.addEventListener("scroll", () => {
      const slides = [...document.querySelectorAll(".profile-slide")];
      const viewportHeight = window.innerHeight;
      const mid = viewportHeight / 2;
      let nearestIdx = currentIndex;
      let minDist = Infinity;
      slides.forEach(s => {
        const rect = s.getBoundingClientRect();
        const dist = Math.abs(rect.top + rect.height/2 - mid);
        if (dist < minDist) {
          minDist = dist;
          nearestIdx = Number(s.dataset.index);
        }
      });
      if (nearestIdx !== currentIndex) {
        currentIndex = nearestIdx;
      }
    });

    // Bootstrap
    loadIdentity();
    async function init() {
      await loadProfiles();
      // ensure first slide is visible
      setTimeout(()=> {
        const first = document.querySelector('.profile-slide');
        if (first) first.scrollIntoView({behavior:"instant"});
      }, 100);
    }
    init();

    // identity load helper
    function loadIdentity() {
      try {
        const stored = JSON.parse(localStorage.getItem("beauty_identity")||"null");
        if (!stored || !stored.username) throw new Error("no identity");
        const today = new Date().toISOString().slice(0,10);
        if (stored.lastLikeDate !== today) {
          stored.likesToday = 0;
          stored.lastLikeDate = today;
        }
        identity = stored;
        localStorage.setItem("beauty_identity", JSON.stringify(identity));
        refreshIdentityUI();
      } catch {
        location.href="auth.html";
      }
    }

    function refreshIdentityUI() {
      if (!identity) return;
      const used = identity.likesToday||0;
      const cap = identity.anonymous ? MAX_LIKES_ANON : MAX_LIKES_LOGGED;
      identityDisplay.innerHTML = identity.anonymous
        ? `Anonymous: <strong>${escapeHTML(identity.username)}</strong>`
        : `Logged in: <strong>${escapeHTML(identity.username)}</strong>`;
      likeStatus.innerHTML = `Likes today: <strong>${used}/${cap}</strong>`;
      if (used >= cap) {
        likeStatus.classList.add("limit-warning");
      } else {
        likeStatus.classList.remove("limit-warning");
      }
    }
  </script>
</body>
</html>