<!DOCTYPE html>
<html>
<head>
  <title>üìä DTech Rate Limit Structural Integrity</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 20px; }
    h1 { color: #00ffc8; }
    .status { margin-bottom: 20px; }
    .green { color: #00ff00; }
    .yellow { color: #ffff00; }
    .orange { color: #ffa500; }
    .red { color: #ff0000; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #444; text-align: center; }
    th { background: #222; }
  </style>
</head>
<body>
  <h1>üìä DTech Rate Limit Structural Integrity</h1>
  <div class="status" id="status">Loading data...</div>
  <div id="stats"></div>
  <table id="serverTable">
    <thead>
      <tr>
        <th>Server</th>
        <th>Avg Integrity</th>
        <th>Samples</th>
        <th>Last Updated</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const TOKENS_URL = "https://gist.githubusercontent.com/Preasx24/137f29d4b3b32c251bf6b7ab2b3fae28/raw/gistfile1.txt";
    const DATA_URL = "https://gist.githubusercontent.com/Preasx24/baaadec8c55a20705b958950ae630b9f/raw/690da2cdc6ce936a1ac4e373d630e95ff0186ecb/rate.json";

    async function fetchWithToken(url, token) {
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
      return res.json();
    }

    function getTokenName(token) {
      return token.slice(-8); // Use last 8 chars as ID
    }

    function colorClass(percent) {
      if (percent > 80) return 'green';
      if (percent > 50) return 'yellow';
      if (percent > 25) return 'orange';
      return 'red';
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString();
    }

    function groupByToken(entries) {
      const servers = {};
      for (const entry of entries) {
        if (!entry.token) continue;
        const id = getTokenName(entry.token);
        if (!servers[id]) servers[id] = [];
        servers[id].push(entry);
      }
      return servers;
    }

    function calculateIntegrity(servers) {
      const rows = [];
      let today = 0, yesterday = 0, thisMonth = 0;
      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);
      const yesterdayStr = new Date(now - 86400000).toISOString().slice(0, 10);
      const monthStr = now.toISOString().slice(0, 7);

      let i = 1;
      for (const [id, samples] of Object.entries(servers)) {
        let totalRem = 0, totalLimit = 0;
        let lastTime = '';
        for (const s of samples) {
          totalRem += s.remaining;
          totalLimit += s.limit;
          lastTime = s.timestamp;
          const day = s.timestamp.slice(0, 10);
          if (day === todayStr) today++;
          if (day === yesterdayStr) yesterday++;
          if (day.startsWith(monthStr)) thisMonth++;
        }
        const integrity = (totalRem / totalLimit) * 100;
        rows.push(`
          <tr>
            <td>Server ${i}</td>
            <td class="${colorClass(integrity)}">${integrity.toFixed(1)}%</td>
            <td>${samples.length}</td>
            <td>${formatDate(lastTime)}</td>
          </tr>
        `);
        i++;
      }

      document.getElementById("stats").innerHTML = `
        <p>‚úÖ Requests Today: <strong>${today}</strong></p>
        <p>üìÖ Requests Yesterday: <strong>${yesterday}</strong></p>
        <p>üìÜ Requests This Month: <strong>${thisMonth}</strong></p>
      `;
      document.querySelector("#serverTable tbody").innerHTML = rows.join('');
    }

    async function loadDashboard() {
      try {
        const tokenList = await (await fetch(TOKENS_URL)).text();
        const tokens = tokenList.trim().split("\n").filter(t => t.startsWith("ghp_"));
        const token = tokens[Math.floor(Math.random() * tokens.length)];
        const data = await fetchWithToken(DATA_URL, token);
        const entries = Array.isArray(data) ? data : [];
        const valid = entries.filter(e => e.token && e.remaining != null);
        const servers = groupByToken(valid);
        calculateIntegrity(servers);
        document.getElementById("status").textContent = "‚úÖ Data loaded successfully";
      } catch (e) {
        document.getElementById("status").textContent = `‚ùå Failed to load data: ${e.message}`;
      }
    }

    loadDashboard();
  </script>
</body>
</html>