<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìä DTech Rate Limit Structural Integrity</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
    h1 {
      color: #58a6ff;
    }
    .status {
      font-size: 1.2em;
      margin: 10px 0;
    }
    .integrity {
      font-weight: bold;
      font-size: 1.5em;
      margin: 15px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #161b22;
    }
    th, td {
      padding: 10px;
      border: 1px solid #30363d;
      text-align: center;
    }
    th {
      background: #21262d;
    }
    .footer {
      margin-top: 20px;
      font-size: 0.9em;
      color: #8b949e;
    }
    .token-short {
      font-family: monospace;
      cursor: pointer;
    }
    .token-full {
      display: none;
      font-family: monospace;
    }
  </style>
</head>
<body>

<h1>üìä DTech Rate Limit Structural Integrity</h1>
<div id="integrity" class="integrity">Loading...</div>
<div class="status">Requests Today: <span id="today">-</span></div>
<div class="status">Requests Yesterday: <span id="yesterday">-</span></div>
<div class="status">Requests This Month: <span id="month">-</span></div>

<table id="statsTable">
  <thead>
    <tr>
      <th>Token</th>
      <th>Remaining</th>
      <th>Limit</th>
      <th>Usage %</th>
      <th>Last Updated</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="footer">
  Data sourced from GitHub Gist with random token authorization
</div>

<script>
(async () => {
  const TOKENS_GIST = "https://gist.githubusercontent.com/Preasx24/137f29d4b3b32c251bf6b7ab2b3fae28/raw/gistfile1.txt";
  const RATE_GIST_API = "https://api.github.com/gists/baaadec8c55a20705b958950ae630b9f";

  function colorFromPercent(p) {
    if (p >= 90) return "#2ecc71"; // green
    if (p >= 70) return "#f1c40f"; // yellow
    if (p >= 40) return "#e67e22"; // orange
    return "#e74c3c"; // red
  }

  function formatToken(token) {
    if (!token) return '';
    const prefix = token.slice(0, 7);
    const suffix = token.slice(-3);
    return `${prefix}...${suffix}`;
  }

  try {
    const tokenListRaw = await fetch(TOKENS_GIST);
    const tokenList = (await tokenListRaw.text()).trim().split('\n').filter(t => t.startsWith('ghp_'));
    const token = tokenList[Math.floor(Math.random() * tokenList.length)];

    const rateRes = await fetch(RATE_GIST_API, {
      headers: { Authorization: `token ${token}` }
    });

    if (!rateRes.ok) throw new Error(`GitHub API error: ${rateRes.status}`);
    
    const rateData = await rateRes.json();
    const contentRaw = rateData.files["rate.json"].content;
    const data = JSON.parse(contentRaw);

    // Group entries by token, keeping only the latest entry for each token
    const tokenMap = new Map();
    data.slice(1).forEach(entry => {
      if (!entry.token) return;
      
      const existing = tokenMap.get(entry.token);
      if (!existing || new Date(entry.timestamp) > new Date(existing.timestamp)) {
        tokenMap.set(entry.token, entry);
      }
    });

    const now = new Date();
    let totalUsed = 0;
    let totalLimit = 0;
    let requestsToday = 0;
    let requestsYesterday = 0;
    let requestsMonth = 0;

    // Calculate totals from all entries (not just latest)
    data.slice(1).forEach(entry => {
      if (!entry.token) return;
      
      const used = entry.limit - entry.remaining;
      const lastUpdated = new Date(entry.timestamp);
      
      if (lastUpdated.toDateString() === now.toDateString()) {
        requestsToday += used;
      }
      if (new Date(now - 86400000).toDateString() === lastUpdated.toDateString()) {
        requestsYesterday += used;
      }
      if (lastUpdated.getMonth() === now.getMonth() && lastUpdated.getFullYear() === now.getFullYear()) {
        requestsMonth += used;
      }
    });

    // Calculate integrity from latest entries only
    const latestEntries = Array.from(tokenMap.values());
    latestEntries.forEach(entry => {
      totalUsed += entry.limit - entry.remaining;
      totalLimit += entry.limit;
    });

    const tbody = document.querySelector("#statsTable tbody");
    tbody.innerHTML = "";

    latestEntries.forEach((entry, index) => {
      const percent = Math.round((entry.remaining / entry.limit) * 100);
      const shortToken = formatToken(entry.token);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>
          <span class="token-short" onclick="this.style.display='none';this.nextElementSibling.style.display='inline'">${shortToken}</span>
          <span class="token-full">${entry.token}</span>
        </td>
        <td>${entry.remaining}</td>
        <td>${entry.limit}</td>
        <td style="color: ${colorFromPercent(percent)}">${100 - percent}%</td>
        <td>${entry.timestamp}</td>
      `;
      tbody.appendChild(row);
    });

    const integrityPercent = Math.round((totalUsed / totalLimit) * 100);
    document.getElementById("integrity").innerText = `Structural Integrity: ${100 - integrityPercent}%`;
    document.getElementById("integrity").style.color = colorFromPercent(100 - integrityPercent);
    document.getElementById("today").innerText = requestsToday;
    document.getElementById("yesterday").innerText = requestsYesterday;
    document.getElementById("month").innerText = requestsMonth;

  } catch (err) {
    document.getElementById("integrity").innerText = `‚ùå Failed to load data: ${err.message}`;
  }
})();
</script>

</body>
</html>