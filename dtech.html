<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìä DTech Rate Limit Structural Integrity</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
    h1 {
      color: #58a6ff;
    }
    h2 {
      color: #58a6ff;
      margin-top: 30px;
      border-bottom: 1px solid #30363d;
      padding-bottom: 5px;
    }
    .status {
      font-size: 1.2em;
      margin: 10px 0;
    }
    .integrity {
      font-weight: bold;
      font-size: 1.5em;
      margin: 15px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #161b22;
    }
    th, td {
      padding: 10px;
      border: 1px solid #30363d;
      text-align: center;
    }
    th {
      background: #21262d;
    }
    .server-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .server-header {
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 10px;
      color: #58a6ff;
    }
    .server-stats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .stat-item {
      margin-bottom: 5px;
    }
    .footer {
      margin-top: 20px;
      font-size: 0.9em;
      color: #8b949e;
    }
  </style>
</head>
<body>

<h1>üìä DTech Rate Limit Structural Integrity</h1>
<div id="integrity" class="integrity">Loading...</div>
<div class="status">Requests Today: <span id="today">-</span></div>
<div class="status">Requests Yesterday: <span id="yesterday">-</span></div>
<div class="status">Requests This Month: <span id="month">-</span></div>

<h2>Server Details</h2>
<div id="serverCards"></div>

<h2>Historical Data</h2>
<table id="statsTable">
  <thead>
    <tr>
      <th>Server</th>
      <th>Token</th>
      <th>Remaining</th>
      <th>Limit</th>
      <th>Usage %</th>
      <th>Last Updated</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="footer">
  Data sourced from GitHub Gist with random token authorization
</div>

<script>
(async () => {
  const TOKENS_GIST = "https://gist.githubusercontent.com/Preasx24/137f29d4b3b32c251bf6b7ab2b3fae28/raw/gistfile1.txt";
  const RATE_GIST_API = "https://api.github.com/gists/baaadec8c55a20705b958950ae630b9f";

  function colorFromPercent(p) {
    if (p >= 90) return "#2ecc71"; // green
    if (p >= 70) return "#f1c40f"; // yellow
    if (p >= 40) return "#e67e22"; // orange
    return "#e74c3c"; // red
  }

  function formatToken(token) {
    return token.substring(0, 8) + '****';
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString();
  }

  try {
    const tokenListRaw = await fetch(TOKENS_GIST);
    const tokenList = (await tokenListRaw.text()).trim().split('\n').filter(t => t.startsWith('ghp_'));
    const token = tokenList[Math.floor(Math.random() * tokenList.length)];

    const rateRes = await fetch(RATE_GIST_API, {
      headers: { Authorization: `token ${token}` }
    });

    if (!rateRes.ok) throw new Error(`GitHub API error: ${rateRes.status}`);
    
    const rateData = await rateRes.json();
    const contentRaw = rateData.files["rate.json"].content;
    const allData = JSON.parse(contentRaw);

    // Filter out entries without token (like the first status entry)
    const tokenEntries = allData.filter(entry => entry.token);
    
    // Group entries by token
    const entriesByToken = {};
    tokenEntries.forEach(entry => {
      if (!entriesByToken[entry.token]) {
        entriesByToken[entry.token] = [];
      }
      entriesByToken[entry.token].push(entry);
    });

    // Get the latest entry for each token
    const latestEntries = Object.keys(entriesByToken).map(token => {
      const entries = entriesByToken[token];
      return entries.reduce((latest, current) => {
        return new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest;
      });
    });

    // Calculate statistics
    const now = new Date();
    let totalUsed = 0;
    let totalLimit = 0;
    let requestsToday = 0;
    let requestsYesterday = 0;
    let requestsMonth = 0;

    // Process all entries for historical data
    tokenEntries.forEach(entry => {
      const used = entry.limit - entry.remaining;
      const lastUpdated = new Date(entry.timestamp);
      
      if (lastUpdated.toDateString() === now.toDateString()) {
        requestsToday += used;
      }
      if (new Date(now - 86400000).toDateString() === lastUpdated.toDateString()) {
        requestsYesterday += used;
      }
      if (lastUpdated.getMonth() === now.getMonth() && lastUpdated.getFullYear() === now.getFullYear()) {
        requestsMonth += used;
      }
    });

    // Process latest entries for server cards and totals
    latestEntries.forEach(entry => {
      const used = entry.limit - entry.remaining;
      totalUsed += used;
      totalLimit += entry.limit;
    });

    // Update summary information
    const integrityPercent = Math.round((totalUsed / totalLimit) * 100);
    document.getElementById("integrity").innerText = `Structural Integrity: ${100 - integrityPercent}%`;
    document.getElementById("integrity").style.color = colorFromPercent(100 - integrityPercent);
    document.getElementById("today").innerText = requestsToday;
    document.getElementById("yesterday").innerText = requestsYesterday;
    document.getElementById("month").innerText = requestsMonth;

    // Create server cards for latest entries
    const serverCardsContainer = document.getElementById("serverCards");
    serverCardsContainer.innerHTML = "";
    
    latestEntries.forEach((entry, index) => {
      const percent = Math.round((entry.remaining / entry.limit) * 100);
      const color = colorFromPercent(percent);
      
      const card = document.createElement("div");
      card.className = "server-card";
      card.innerHTML = `
        <div class="server-header">Server ${index + 1}</div>
        <div class="server-stats">
          <div class="stat-item"><strong>Token:</strong> ${formatToken(entry.token)}</div>
          <div class="stat-item"><strong>Remaining:</strong> ${entry.remaining}</div>
          <div class="stat-item"><strong>Limit:</strong> ${entry.limit}</div>
          <div class="stat-item"><strong>Usage:</strong> <span style="color: ${color}">${100 - percent}%</span></div>
          <div class="stat-item"><strong>Last Updated:</strong> ${formatDate(entry.timestamp)}</div>
        </div>
      `;
      serverCardsContainer.appendChild(card);
    });

    // Populate historical data table
    const tbody = document.querySelector("#statsTable tbody");
    tbody.innerHTML = "";
    
    tokenEntries.forEach((entry, index) => {
      const percent = Math.round((entry.remaining / entry.limit) * 100);
      const color = colorFromPercent(percent);
      
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>Server ${index + 1}</td>
        <td>${formatToken(entry.token)}</td>
        <td>${entry.remaining}</td>
        <td>${entry.limit}</td>
        <td style="color: ${color}">${100 - percent}%</td>
        <td>${formatDate(entry.timestamp)}</td>
      `;
      tbody.appendChild(row);
    });

  } catch (err) {
    document.getElementById("integrity").innerText = `‚ùå Failed to load data: ${err.message}`;
  }
})();
</script>

</body>
</html>