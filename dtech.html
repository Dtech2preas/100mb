<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📊 GitHub Token Usage Stats</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      background: #f9f9f9;
      color: #333;
    }
    h1, h2 {
      text-align: center;
    }
    .stats, .server {
      background: #fff;
      padding: 1rem;
      margin: 1rem auto;
      max-width: 800px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>📊 GitHub Token Rate Limit Stats</h1>
  <div id="summary" class="stats">Loading...</div>
  <div id="servers"></div>

  <script>
    const GIST_URL = 'https://gist.githubusercontent.com/Preasx24/baaadec8c55a20705b958950ae630b9f/raw/rate.json';

    async function loadStats() {
      const res = await fetch(GIST_URL);
      const data = await res.json();

      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);
      const yesterdayStr = new Date(now - 86400000).toISOString().slice(0, 10);
      const monthStr = now.toISOString().slice(0, 7);

      const usage = {};
      const daysUsed = new Set();
      let totalToday = 0, totalYesterday = 0, totalMonth = 0;

      data.forEach(entry => {
        const { token, remaining, limit, timestamp } = entry;
        const date = timestamp.slice(0, 10);
        const key = token.slice(0, 10) + '...';

        if (!usage[key]) usage[key] = [];
        usage[key].push(entry);

        const used = limit - remaining;
        if (date === todayStr) totalToday += used;
        if (date === yesterdayStr) totalYesterday += used;
        if (date.startsWith(monthStr)) totalMonth += used;

        daysUsed.add(date);
      });

      // Summary Section
      const summary = document.getElementById("summary");
      summary.innerHTML = `
        <h2>📅 Summary</h2>
        <p><strong>Today’s Requests:</strong> ${totalToday}</p>
        <p><strong>Yesterday’s Requests:</strong> ${totalYesterday}</p>
        <p><strong>This Month’s Requests:</strong> ${totalMonth}</p>
        <p><strong>Average Per Day:</strong> ${Math.round(totalMonth / daysUsed.size)}</p>
        <p><strong>Total Days Tracked:</strong> ${daysUsed.size}</p>
      `;

      // Server-specific data
      const serverDiv = document.getElementById("servers");
      for (const token in usage) {
        const logs = usage[token];
        logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        let totalUsed = 0;
        for (let i = 1; i < logs.length; i++) {
          const prev = logs[i - 1];
          const curr = logs[i];
          const used = (prev.remaining || 0) - (curr.remaining || 0);
          if (used >= 0) totalUsed += used;
        }

        const last = logs[logs.length - 1];
        const first = logs[0];

        const entryHTML = `
          <div class="server">
            <h2>🔐 ${token}</h2>
            <p><strong>First Check:</strong> ${first.timestamp}</p>
            <p><strong>Last Check:</strong> ${last.timestamp}</p>
            <p><strong>Entries:</strong> ${logs.length}</p>
            <p><strong>Total Used:</strong> ${totalUsed}</p>
            <p><strong>Remaining Now:</strong> ${last.remaining}</p>
            <p><strong>Limit:</strong> ${last.limit}</p>
          </div>
        `;
        serverDiv.innerHTML += entryHTML;
      }
    }

    loadStats();
  </script>
</body>
</html>